<!DOCTYPE html>
<meta charset="utf-8" />
<title>Mouse Delta Tester</title>
<style>
  body {
    font: 16px/1.4 sans-serif;
    margin: 40px;
  }
  .stat {
    margin-top: 8px;
    font-family: monospace;
  }
  .reset-button {
    margin-bottom: 20px;
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  .reset-button:hover {
    background-color: #0056b3;
  }
  .progress-container {
    margin: 20px 0;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
  }
  .progress-message {
    text-align: center;
    font-size: 18px;
    color: #495057;
    margin-bottom: 15px;
    transition: color 0.3s ease;
  }
  .progress-message.fast-mode {
    color: #dc3545;
    font-weight: bold;
  }
  .progress-bar {
    width: 100%;
    height: 20px;
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background-color: #28a745;
    width: 0%;
    transition: width 0.3s ease;
  }
  .results-container {
    display: none;
  }
  .results-container.show {
    display: block;
  }
</style>

<h2>Mouse Delta Tester</h2>

<div class="progress-container" id="progressContainer">
  <div class="progress-message">Scroll with your mousewheel or trackpad</div>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
</div>

<div class="results-container" id="resultsContainer">
  <button class="reset-button" onclick="resetStats()">Reset</button>

  <h3>Normalized</h3>
  <div class="stat" id="minDelta"></div>
  <div class="stat" id="maxDelta"></div>
  <div class="stat" id="avgDelta"></div>
  <h3>Raw</h3>
  <div class="stat" id="minDeltaRaw"></div>
  <div class="stat" id="maxDeltaRaw"></div>
  <div class="stat" id="avgDeltaRaw"></div>
  <h3>Device</h3>
  <div class="stat" id="devicePixelRatio"></div>
  <div class="stat" id="hostOS"></div>

  <br />
  <a href="https://github.com/wilg/mouse-delta-tester">View on GitHub</a>
</div>

<script>
  /* ── element handles ────────────────────────────────────────────────────── */
  const elDevicePixelRatio = document.getElementById("devicePixelRatio");
  const elHostOS = document.getElementById("hostOS");
  const elMin = document.getElementById("minDelta");
  const elMax = document.getElementById("maxDelta");
  const elAvg = document.getElementById("avgDelta");
  const elMinRaw = document.getElementById("minDeltaRaw");
  const elMaxRaw = document.getElementById("maxDeltaRaw");
  const elAvgRaw = document.getElementById("avgDeltaRaw");
  const elProgressFill = document.getElementById("progressFill");
  const elProgressContainer = document.getElementById("progressContainer");
  const elResultsContainer = document.getElementById("resultsContainer");

  /* ── stats ───────────────────────────────────────────────────────────────── */
  const REQUIRED_EVENTS = 100; // Number of events needed to fill the progress bar
  let scrollDeltas = [];
  let normalizedDeltas = [];
  let minDelta = 0;
  let maxDelta = 0;
  let totalDelta = 0;
  let minDeltaRaw = 0;
  let maxDeltaRaw = 0;
  let totalDeltaRaw = 0;
  let eventCount = 0;
  let hasEvents = false;
  let progressComplete = false;

  /* ── get device pixel ratio ─────────────────────────────────────────────── */
  const devicePixelRatio = window.devicePixelRatio || 1;

  /* ── get host OS ────────────────────────────────────────────────────────── */
  function getHostOS() {
    const userAgent = navigator.userAgent;
    const platform = navigator.platform;

    if (userAgent.includes("Windows")) return "Windows";
    if (userAgent.includes("Mac")) return "macOS";
    if (userAgent.includes("Linux")) return "Linux";
    if (userAgent.includes("Android")) return "Android";
    if (userAgent.includes("iOS")) return "iOS";

    // Fallback to platform
    if (platform.includes("Win")) return "Windows";
    if (platform.includes("Mac")) return "macOS";
    if (platform.includes("Linux")) return "Linux";

    return "Unknown";
  }

  /* ── initialize host OS ─────────────────────────────────────────────────── */
  let hostOS = getHostOS();

  /* ── listen for every wheel packet ──────────────────────────────────────── */
  document.addEventListener(
    "wheel",
    (ev) => {
      ev.preventDefault(); // stop page scrolling
      const delta = Math.abs(ev.deltaY); // raw pixels
      if (!delta) return;

      AddScrollEvent(delta);
    },
    { passive: false }
  );

  function AddScrollEvent(delta) {
    // Stop updating stats if progress is already complete
    if (progressComplete) return;

    const normalizedDelta = delta / devicePixelRatio;
    scrollDeltas.push(delta);
    normalizedDeltas.push(normalizedDelta);
    eventCount++;
    totalDelta += normalizedDelta;
    totalDeltaRaw += delta;

    if (!hasEvents) {
      minDelta = normalizedDelta;
      maxDelta = normalizedDelta;
      minDeltaRaw = delta;
      maxDeltaRaw = delta;
      hasEvents = true;
    } else {
      if (normalizedDelta < minDelta) minDelta = normalizedDelta;
      if (normalizedDelta > maxDelta) maxDelta = normalizedDelta;
      if (delta < minDeltaRaw) minDeltaRaw = delta;
      if (delta > maxDeltaRaw) maxDeltaRaw = delta;
    }

    // Update progress bar
    const progress = Math.min((eventCount / REQUIRED_EVENTS) * 100, 100);
    elProgressFill.style.width = progress + "%";

    // Update progress message based on current phase
    const progressMessage = document.querySelector(".progress-message");
    if (eventCount <= REQUIRED_EVENTS / 2) {
      progressMessage.textContent = "Scroll as slowly as possible";
      progressMessage.classList.remove("fast-mode");
    } else {
      progressMessage.textContent = "Scroll as fast as possible";
      progressMessage.classList.add("fast-mode");
    }

    // Show results when progress is complete
    if (eventCount >= REQUIRED_EVENTS) {
      progressComplete = true;
      elProgressContainer.style.display = "none";
      elResultsContainer.classList.add("show");
    }
  }

  function resetStats() {
    scrollDeltas = [];
    normalizedDeltas = [];
    minDelta = 0;
    maxDelta = 0;
    totalDelta = 0;
    minDeltaRaw = 0;
    maxDeltaRaw = 0;
    totalDeltaRaw = 0;
    eventCount = 0;
    hasEvents = false;
    progressComplete = false;

    // Reset progress bar and show it again
    elProgressFill.style.width = "0%";
    elProgressContainer.style.display = "block";
    elResultsContainer.classList.remove("show");

    // Reset progress message
    const progressMessage = document.querySelector(".progress-message");
    progressMessage.textContent = "Scroll as slowly as possible";
    progressMessage.classList.remove("fast-mode");
  }

  /* ── update display ──────────────────────────────────────────────────────── */
  function step() {
    elDevicePixelRatio.innerHTML = `<b>Device Pixel Ratio</b><br>${devicePixelRatio.toFixed(
      2
    )}`;

    elHostOS.innerHTML = `<b>Host OS</b><br>${hostOS}`;

    if (!hasEvents) {
      elMin.textContent = "";
      elMax.textContent = "";
      elAvg.textContent = "";
      elMinRaw.textContent = "";
      elMaxRaw.textContent = "";
      elAvgRaw.textContent = "";
    } else {
      elMin.innerHTML = `<b>Min (Normalized)</b><br>${minDelta.toFixed(
        2
      )} CSS pixels/event`;
      elMax.innerHTML = `<b>Max (Normalized)</b><br>${maxDelta.toFixed(
        2
      )} CSS pixels/event`;
      elAvg.innerHTML = `<b>Avg (Normalized)</b><br>${(
        totalDelta / eventCount
      ).toFixed(2)} pixels/event`;
      elMinRaw.innerHTML = `<b>Min (Raw)</b><br>${minDeltaRaw.toFixed(
        2
      )} device pixels/event`;
      elMaxRaw.innerHTML = `<b>Max (Raw)</b><br>${maxDeltaRaw.toFixed(
        2
      )} device pixels/event`;
      elAvgRaw.innerHTML = `<b>Avg (Raw)</b><br>${(
        totalDeltaRaw / eventCount
      ).toFixed(2)} device pixels/event`;
    }

    requestAnimationFrame(step);
  }
  step();
</script>
